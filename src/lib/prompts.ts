import { QuestionType, Difficulty, QuestionTypes, Difficulties } from './types';

// 난이도별 공통 프롬프트
const difficultyPrompts: Record<Difficulty, string> = {
  [Difficulties.HIGH]: `
# 난이도: 상
- 복잡한 다단계 추론이 필요한 문항을 출제하세요.
- 암시적이고 함축적인 의미를 파악해야 하는 문항을 포함하세요.
- 지문의 심층적 이해와 비판적 사고를 요구하는 문항을 만드세요.
- 다양한 정보를 종합적으로 분석해야 하는 문항을 출제하세요.`,
  
  [Difficulties.MEDIUM]: `
# 난이도: 중
- 기본적인 추론이 필요한 문항을 출제하세요.
- 지문의 주요 내용을 정확히 이해했는지 확인하는 문항을 포함하세요.
- 명시적인 내용과 암시적 내용을 균형있게 다루는 문항을 만드세요.`,
  
  [Difficulties.LOW]: `
# 난이도: 하
- 지문에 명시적으로 드러난 정보를 확인하는 문항을 출제하세요.
- 단순한 사실 확인이나 정보 파악이 가능한 문항을 포함하세요.
- 직접적인 내용 이해를 중심으로 하는 문항을 만드세요.`
};

// 문제 유형별 상세 프롬프트
const typePrompts: Record<QuestionType, string> = {
  [QuestionTypes.FACTUAL_UNDERSTANDING]: `특히 사실적 이해 문항(지문에 명시적으로 언급된 정보에 대한 질문)에 집중해주세요.

사실적 이해 문항은 반드시:
1. 지문에 직접적으로 명시된 정보를 파악하는 질문이어야 합니다
2. 단순한 사실/정보의 확인이나 세부 내용 파악에 초점을 두어야 합니다
3. 주로 "윗글에 대한 이해로 가장 적절한 것은?", "윗글에서 언급된 내용으로 가장 적절한 것은?" 등의 형식을 취해야 합니다

질문 형식의 예시:
- "윗글에서 알 수 있는 사실로 가장 적절한 것은?"
- "윗글에 제시된 정보로 적절하지 않은 것은?"
- "윗글에서 설명하고 있는 <개념/현상>에 대한 이해로 가장 적절한 것은?"

오답 선택지는 지문의 내용과 명확히 불일치하거나, 지문에 언급되지 않은 내용, 또는 지문의 내용을 왜곡한 내용으로 구성하세요.`,
  
  [QuestionTypes.INFERENCE]: `특히 추론적 이해 문항(지문의 내용을 바탕으로 추론해야 하는 질문)에 집중해주세요.

추론적 이해 문항은 반드시:
1. 지문에 직접적으로 언급되지 않았지만 내용을 바탕으로 논리적으로 추론할 수 있는 내용을 파악하도록 해야 합니다
2. 지문의 문맥을 고려하여 함축적 의미를 파악하는 능력을 평가해야 합니다
3. "윗글로 미루어 볼 때", "윗글을 바탕으로 추론할 때" 등의 표현을 포함해야 합니다

질문 형식의 예시:
- "윗글을 통해 추론할 수 있는 내용으로 가장 적절한 것은?"
- "윗글로 미루어 볼 때, 다음 중 가장 적절하지 않은 것은?"
- "윗글의 <개념/현상>에 대한 이해로 적절하지 않은 것은?"

이 문항에서는 단순한 사실 확인이 아닌, 독자가 지문의 내용을 바탕으로 논리적으로 추론할 수 있는 내용을 출제해야 합니다.`,
  
  [QuestionTypes.AUTHOR_INTENTION]: `특히 글쓴이 의도 파악 문항에 집중해주세요.

질문 형식의 예시:
- "윗글에서 글쓴이가 주로 사용한 설명 방식으로 가장 적절한 것은?"
- "윗글을 쓴 글쓴이의 의도로 가장 적절한 것은?"
- "<개념/대상>에 대한 글쓴이의 태도로 가장 적절한 것은?"
- "글쓴이가 이 글을 쓴 목적으로 가장 적절한 것은?"

글쓴이 의도 파악 문항은 반드시:
1. 글쓴이의 관점, 태도, 주장, 의도, 목적 등을 파악하도록 해야 합니다
2. 지문의 전체적인 맥락에서 글쓴이의 의도와 태도를 추론해야 합니다
3. 글쓴이가 사용한 설명 방식, 서술 전략, 논증 방식 등을 파악하도록 해야 합니다`,
  
  [QuestionTypes.UNDERLINED_SENTENCE]: `특히 밑줄 친 부분의 의미나 기능 파악 문항에 집중해주세요.

질문 형식의 예시:
- "윗글에서 <밑줄 친 부분>의 의미로 가장 적절한 것은?"
- "<밑줄 친 부분>의 문맥적 의미로 가장 적절한 것은?"
- "<밑줄 친 부분>에 나타난 글쓴이의 의도로 가장 적절한 것은?"

밑줄 친 부분 문항은 반드시:
1. 문장이나 구절이 전체 지문에서 갖는 의미나 기능을 파악하도록 해야 합니다
2. 문맥을 고려한 정확한 의미 파악이 필요한 부분을 선택해야 합니다
3. 지문에서 핵심적인 개념이나 주장을 담고 있는 부분을 선택해야 합니다

지문에서 중요하거나 의미가 함축적인 문장을 ㉠, ㉡, ㉢과 같은 기호로 표시하고 동시에 <밑줄> 태그로 마킹해야 합니다.`,
  
  [QuestionTypes.PATTERN_ANALYSIS]: `특히 패턴 분석 문항(글의 구조, 전개 방식, 서술 방법 분석)에 집중해주세요.

글쓴이가 사용한 논리적 구성과 내용 전개 방식, 특정 구성 요소의 전략적 배치를 파악하는 문항을 출제해야 합니다. 
지문의 각 문단이 어떤 역할을 하는지, 어떤 패턴(설명-예시, 원인-결과, 비교-대조, 문제-해결 등)으로 내용이 전개되는지 분석하는 문항을 출제하세요.

질문 형식의 예시:
- "윗글의 전개 방식으로 가장 적절한 것은?"
- "윗글의 구조적 특징으로 가장 적절한 것은?"
- "윗글에서 사용된 설명 방식으로 가장 적절한 것은?"`,
  
  [QuestionTypes.ARGUMENT_STRUCTURE]: `특히 논증 구조 문항(주장과 근거, 전제와 결론, 숨겨진 가정 등의 분석)에 집중해주세요.

글쓴이의 주장이 어떻게 논증되고 있는지, 어떤 근거를 통해 결론이 도출되는지, 논증 과정에 숨겨진 전제나 가정은 무엇인지를 파악하는 문항을 출제해야 합니다.

질문 형식의 예시:
- "윗글에서 사용된 논증 방식으로 가장 적절한 것은?"
- "윗글의 논증 구조에 대한 설명으로 가장 적절한 것은?"
- "윗글에서 글쓴이가 전제하고 있는 것으로 가장 적절한 것은?"`,
  
  [QuestionTypes.CONCEPT_COMPARISON]: `특히 개념 비교 문항에 집중해주세요.

개념 비교 문항은 반드시:
1. 지문에 제시된 여러 개념, 이론, 용어 간의 관계를 정확히 파악하도록 해야 합니다
2. 개념 간의 공통점과 차이점을 명확히 구분할 수 있어야 합니다
3. 개념의 정의, 특징, 적용 범위, 한계 등을 다각도로 비교하는 능력을 측정해야 합니다

질문 형식의 예시:
- "윗글에 제시된 A와 B의 공통점으로 가장 적절한 것은?"
- "윗글의 A와 B를 비교한 내용으로 적절하지 않은 것은?"
- "윗글에서 설명한 여러 개념들의 관계에 대한 이해로 가장 적절한 것은?"`,
  
  [QuestionTypes.PERSPECTIVE_COMPARISON]: `특히 관점 비교 문항에 집중해주세요.

관점 비교 문항은 반드시:
1. 지문에 제시된 서로 다른 관점, 이론, 입장 간의 차이를 파악하도록 해야 합니다
2. 각 관점이 기반하는 전제와 가정, 근거를 비교할 수 있어야 합니다
3. 관점 간의 핵심 쟁점과 논증 방식, 논리적 결과를 비교하는 능력을 측정해야 합니다

질문 형식의 예시:
- "윗글에 제시된 A의 관점과 B의 관점을 비교한 내용으로 가장 적절한 것은?"
- "윗글의 A 이론과 B 이론의 차이점으로 적절하지 않은 것은?"
- "윗글에서 설명한 두 입장의 핵심 쟁점에 대한 이해로 가장 적절한 것은?"`,
  
  [QuestionTypes.VALIDITY_EVALUATION]: `특히 타당성 평가 문항에 집중해주세요.

타당성 평가 문항은 반드시:
1. 지문에 제시된 주장이나 이론의 논리적 타당성을 평가하도록 해야 합니다
2. 주장의 근거가 논리적으로 타당한지, 숨겨진 가정은 무엇인지 파악할 수 있어야 합니다
3. 주장이나 이론의 강점과 약점, 적용 가능성과 한계를 비판적으로 분석하는 능력을 측정해야 합니다

질문 형식의 예시:
- "윗글에 제시된 A 이론의 한계로 가장 적절한 것은?"
- "윗글의 주장에 대한 비판으로 적절하지 않은 것은?"
- "윗글에서 설명한 이론의 타당성을 평가한 내용으로 가장 적절한 것은?"`,
  
  [QuestionTypes.PRINCIPLE_APPLICATION]: `특히 원리 적용 문항에 집중해주세요.

원리 적용 문항은 반드시:
1. 지문에 제시된 이론이나 원리를 정확히 이해하고, 이를 새로운 상황에 적용하도록 해야 합니다
2. 원리의 핵심 개념과 적용 조건을 정확히 파악하는 능력을 측정해야 합니다
3. <보기>에 제시된 사례나 상황에 원리를 정확히 적용하는 능력을 측정해야 합니다

질문 형식의 예시:
- "윗글에서 설명한 원리를 <보기>에 적용한 것으로 가장 적절한 것은?"
- "<보기>는 윗글에서 설명한 A의 사례이다. 이에 대한 설명으로 가장 적절한 것은?"
- "윗글의 관점에서 <보기>의 상황을 이해한 것으로 가장 적절한 것은?"

이 문항은 <보기>를 포함해야 합니다. <보기>는 지문에서 설명한 원리를 적용할 수 있는 구체적 사례나 상황을 제시해야 합니다.`,
  
  [QuestionTypes.COMPLEX_DATA_INTERPRETATION]: `특히 복합 자료 해석 문항에 집중해주세요.

복합 자료 해석 문항은 반드시:
1. 다양한 유형의 자료(표, 그래프, 도표, 사례 등)를 통합적으로 분석하고 해석하도록 해야 합니다
2. 자료 간의 관계를 파악하고 종합적인 결론을 도출하는 능력을 측정해야 합니다
3. <보기>에 제시된 복합적인 자료를 지문의 관점에서 해석하는 능력을 측정해야 합니다

질문 형식의 예시:
- "윗글을 바탕으로 <보기>의 자료를 해석한 것으로 가장 적절한 것은?"
- "<보기>의 자료에 대한 분석으로 적절하지 않은 것은?"
- "윗글의 관점에서 <보기>의 그래프를 해석한 것으로 가장 적절한 것은?"

이 문항은 <보기>를 포함해야 합니다. <보기>는 여러 형태의 자료를 포함해야 합니다.`,
  
  [QuestionTypes.PROBLEM_SOLVING]: `특히 문제 해결 문항에 집중해주세요.

문제 해결 문항은 반드시:
1. 지문에 제시된 원리나 이론을 바탕으로 구체적인 문제 상황을 분석하도록 해야 합니다
2. 문제의 핵심 요소를 파악하고, 적절한 해결 과정을 설계하는 능력을 측정해야 합니다
3. <보기>에 제시된 문제 상황을 지문의 관점에서 해결하는 능력을 측정해야 합니다

질문 형식의 예시:
- "윗글의 관점에서 <보기>의 문제를 해결하는 방안으로 가장 적절한 것은?"
- "<보기>의 상황에 윗글의 방법을 적용한 것으로 가장 적절한 것은?"
- "윗글의 이론을 바탕으로 <보기>의 문제점을 분석한 것으로 가장 적절한 것은?"

이 문항은 <보기>를 포함해야 합니다. <보기>는 해결이 필요한 구체적인 문제 상황을 제시해야 합니다.`,
  
  [QuestionTypes.WORD_MEANING]: `특히 어휘 의미 파악 문항에 집중해주세요.

어휘 의미 파악 문항은 반드시:
1. 지문 속에서 사용된 어휘의 문맥적 의미를 정확히 파악하도록 해야 합니다
2. 유사한 의미를 가진 다른 표현이나 단어를 찾도록 해야 합니다
3. 주로 "밑줄 친 단어와 가장 가까운 의미로 쓰인 것은?", "문맥상 ○○와 바꿔 쓸 수 있는 것은?" 등의 형식을 취해야 합니다

질문 형식의 예시:
- "윗글에서 '○○'의 의미와 가장 가까운 것은?"
- "밑줄 친 '○○'를 바꿔 쓰기에 가장 적절한 것은?"
- "다음 중 '○○'가 문맥상 ㉠과 가장 유사한 의미로 사용된 것은?"`,
  
  [QuestionTypes.CONCEPT_UNDERSTANDING]: `특히 개념/용어 이해 문항에 집중해주세요.

개념/용어 이해 문항은 반드시:
1. 지문에서 설명된 전문적인 개념이나 학술적 용어의 정확한 의미를 파악하도록 해야 합니다
2. 개념의 핵심 특징, 적용 범위, 한계 등을 정확히 이해했는지 확인해야 합니다
3. 주로 "윗글에서 설명한 '○○'에 대한 이해로 가장 적절한 것은?", "윗글의 '○○'에 대한 설명으로 가장 적절한 것은?" 등의 형식을 취해야 합니다

질문 형식의 예시:
- "윗글에서 설명한 '○○' 개념에 대한 이해로 가장 적절한 것은?"
- "윗글의 '○○'에 대한 설명으로 적절하지 않은 것은?"
- "윗글에 제시된 '○○'의 특징으로 가장 적절한 것은?"`
};

// 공통 기본 프롬프트
const basePrompt = `당신은 독해 문제를 전문으로 하는 수능 국어 문제 출제자입니다. 2024학년도 수능 출제 기준에 따라 학생들의 지문 이해도를 평가하는 문항을 만드는 것이 당신의 역할입니다.

# 중요 지침
- 출제하는 문항은 반드시 제시된 문제 유형에 맞는 형식과 내용이어야 합니다.
- 각 유형마다 다른 문항 형식과 평가 목표가 있으므로, 유형별 특성을 정확히 반영해야 합니다.

# 핵심 문제 출제 규칙
1. 출제 목표
- 2015 개정 교육과정 기반의 대학 수준 국어 능력 측정
- 교과서 기반 지식과 기능 이해도 평가
- 다양한 텍스트에 적용 가능한 창의적 사고력 측정

2. 필수 요소
A. 문항 형식
- 문제 유형에 맞는 적절한 질문 형식 사용
- 명확하고 구체적인 질문

B. 선택지 설계
- ①-⑤로 표시된 5개 선택지 사용
- 정답은 명확한 텍스트 근거가 있어야 함
- 오답 선택지는 그럴듯하지만 명확히 틀린 내용으로 구성
- 오답 선택지 설계 시 활용:
  * 과잉 일반화
  * 부분적 이해
  * 인과관계 오류
  * 맥락 무시

3. 평가 기준
정답의 경우:
- 명확한 텍스트 근거 제시
- 전체적인 구조 파악
- 문단 간 관계 정확히 이해

오답의 경우:
- 부분적 이해에 기반
- 유사하지만 부정확한 내용
- 논리적 오류를 포함한 평가

# 제약조건
- 전체 출제문항 수에 대한 문항과 선택지를 우선적으로 모두 처리한 후, 이후에 정답과 해설을 표기한다.
- 다른 부연설명은 하지 않으며 문항부터 출력을 실행한다.
- 정답 해설시에는 반드시 정답번호를 함께 표기하여 해설을 진행한다.

# 응답 형식
다음 JSON 형식으로 응답해주세요:

[
  {
    "id": "1",
    "text": "문제 내용",
    "example": "<보기>\\n[구체적인 사례나 상황 설명] (필요한 경우만)",
    "options": [
      "① 선택지 1",
      "② 선택지 2",
      "③ 선택지 3",
      "④ 선택지 4",
      "⑤ 선택지 5"
    ],
    "correctAnswer": 정답 번호(1~5),
    "explanation": "정답 해설: [정답의 번호와 정답이 옳은 이유 설명]\\n오답 해설: [각 오답이 틀린 이유를 설명]"
  }
]

JSON 형식만 응답해주세요.`;

export function buildPrompt(
  passage: string,
  questionType: QuestionType,
  count: number,
  difficulty: Difficulty
): string {
  const needsMarking = questionType === QuestionTypes.UNDERLINED_SENTENCE;
  const needsExample = (
    questionType === QuestionTypes.PRINCIPLE_APPLICATION ||
    questionType === QuestionTypes.COMPLEX_DATA_INTERPRETATION ||
    questionType === QuestionTypes.PROBLEM_SOLVING
  );
  
  return `${basePrompt}

${difficultyPrompts[difficulty]}

${typePrompts[questionType]}

${needsMarking ? '# 중요: 지문에 ㉠, ㉡ 등의 기호와 <밑줄> 태그로 중요 부분을 표시한 후 문제를 출제하세요.' : ''}
${needsExample ? '# 중요: 이 문항 유형은 반드시 <보기>를 포함해야 합니다.' : ''}

# 지문
${passage}

# 출제 문항 수: ${count}

JSON 형식만 응답해주세요.`;
}

// 밑줄 마킹용 프롬프트
export function buildMarkingPrompt(passage: string, count: number): string {
  return `다음 지문을 분석하여 의미 해석이 중요한 핵심 문장이나 구절 ${count}개를 선택하고, 선택한 문장/구절에 '㉠', '㉡', '㉢'과 같은 기호로 표시하고 동시에 <밑줄> 태그로 마킹해주세요. 특히 글쓴이의 의도가 드러나거나, 글의 핵심 주장이 담겨있거나, 해석의 여지가 있는 문장을 선택하세요.

선택 기준:
1. 글의 핵심 주장이나 논지가 담긴 문장
2. 텍스트 이해에 중요한 개념이나 용어가 정의된 문장
3. 글쓴이의 관점이나 태도가 명확히 드러나는 문장
4. 해석의 여지가 있거나 다양한 관점에서 분석할 수 있는 문장

마킹 방법:
- 원본 텍스트를 그대로 유지하면서 선택한 문장/구절에 '㉠', '㉡', '㉢'과 같은 기호를 붙이고 동시에 <밑줄> 태그로 감싸서 표시
- 예: 그 중에서도 특히 ㉠<밑줄>눈에 보이지 않는 미래의 가치를 현재의 관점에서 평가하는 일은 쉽지 않다.</밑줄>
- 정확히 ${count}개의 밑줄만 표시해주세요.
- 첫 번째 선택한 문장/구절은 ㉠, 두 번째는 ㉡, 세 번째는 ㉢으로 표시하세요.

지문:
${passage}

마킹된 지문만 출력해주세요. 다른 설명은 추가하지 마세요.`;
}